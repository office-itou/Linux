#!/bin/bash
###############################################################################
##
##	ファイル名	:	addusers_txt_maker.sh
##
##	機能概要	:	addusers.txt作成用シェル (既存sambaユーザーの抜き出し)
##	---------------------------------------------------------------------------
##	<対象OS>	:	Debian 7 ～
##				:	Ubuntu 18.04 ～
##				:	CentOS 7 ～
##	---------------------------------------------------------------------------
##	<サービス>	:	samba / smbd,nmbd / smb,nmb
##	---------------------------------------------------------------------------
##	入出力 I/F
##		INPUT	:	
##		OUTPUT	:	
##
##	作成者		:	J.Itou
##
##	作成日付	:	2016/02/11
##
##	改訂履歴	:	
##	   日付       版         名前      改訂内容
##	---------- -------- -------------- -----------------------------------------
##	2016/02/11 000.0000 J.Itou         新規作成
##	2018/02/25 000.0000 J.Itou         改善対応
##	2018/05/05 000.0000 J.Itou         改善対応
##	2018/06/03 000.0000 J.Itou         改善対応
##	2022/05/06 000.0000 J.Itou         不具合修正
##	YYYY/MM/DD 000.0000 xxxxxxxxxxxxxx 
###############################################################################
#	set -n								# 構文エラーのチェック
#	set -x								# コマンドと引数の展開を表示
	set -o ignoreeof					# Ctrl+Dで終了しない
	set +m								# ジョブ制御を無効にする
	set -e								# ステータス0以外で終了
	set -u								# 未定義変数の参照で終了

	echo "*******************************************************************************"
	echo "`date +"%Y/%m/%d %H:%M:%S"` 作成処理を開始します。"
	echo "*******************************************************************************"

	trap 'exit 1' 1 2 3 15

# Pause処理 -------------------------------------------------------------------
funcPause() {
	local RET_STS=$1

	if [ ${RET_STS} -ne 0 ]; then
		echo "Enterキーを押して下さい。"
		read DUMMY
	fi
}

# *****************************************************************************
# 初期設定
# *****************************************************************************
	# *************************************************************************
	# Initialize
	# *************************************************************************
	echo - Initialize ------------------------------------------------------------------
	#--------------------------------------------------------------------------
	NOW_DATE=`date +"%Y/%m/%d"`													# yyyy/mm/dd
	NOW_TIME=`date +"%Y%m%d%H%M%S"`												# yyyymmddhhmmss
	PGM_NAME=`basename $0 | sed -e 's/\..*$//'`									# プログラム名
	#--------------------------------------------------------------------------
	WHO_AMI=`whoami`															# 実行ユーザー名
	if [ "${WHO_AMI}" != "root" ]; then
		echo "rootユーザーで実行して下さい。"
		exit 1
	fi
	# samba -------------------------------------------------------------------
	SMB_USER=sambauser															# smb.confのforce user
	SMB_GRUP=sambashare															# smb.confのforce group
	SMB_GADM=sambaadmin															# smb.confのadmin group
	# ワーク変数設定 ----------------------------------------------------------
	DIR_WK=${PWD}
	LST_USER=${DIR_WK}/addusers.txt

# *****************************************************************************
# Main処理                                                                    *
# *****************************************************************************
	# *************************************************************************
	# Make User file (${DIR_WK}/addusers.txtが有ればそれを使う)
	# *************************************************************************
	echo - Make User file --------------------------------------------------------------
	# -------------------------------------------------------------------------
	rm -f ${LST_USER}
	touch ${LST_USER}

	while IFS=':' read WORKNAME USERIDNO LMPASSWD NTPASSWD ACNTFLAG CHNGTIME
	do
		USERNAME="${WORKNAME,,}"
		FULLNAME=`pdbedit -u ${USERNAME} | awk -F : '{print $3;}'`
		PASSWORD=""

		IDGROUPS=`id -G -n ${USERNAME} | awk '/sambaadmin/'`
		if [ "${IDGROUPS}" = "" ]; then
			ADMINFLG=0
		else
			ADMINFLG=1
		fi

		echo "${USERNAME}:${FULLNAME}:${USERIDNO}:${PASSWORD}:${LMPASSWD}:${NTPASSWD}:${ACNTFLAG}:${CHNGTIME}:${ADMINFLG}" >> ${LST_USER}
	done < <(pdbedit -L -w)
	# -------------------------------------------------------------------------
	echo --- ${SMB_GRUP} ---------------------------------------------------------------
	awk -F ':' '$1=="'${SMB_GRUP}'" {print $4;}' /etc/group
	echo --- ${SMB_GADM} ---------------------------------------------------------------
	awk -F ':' '$1=="'${SMB_GADM}'" {print $4;}' /etc/group
	echo ------------------------------------------------------------------------------

	# *************************************************************************
	# Termination
	# *************************************************************************
	echo - Termination -----------------------------------------------------------------
	# -------------------------------------------------------------------------

# *****************************************************************************
# Exit
# *****************************************************************************
	echo "*******************************************************************************"
	echo "`date +"%Y/%m/%d %H:%M:%S"` 作成処理が終了しました。"
	echo "*******************************************************************************"

	exit 0

#==============================================================================
# End of file                                                                 =
#==============================================================================
